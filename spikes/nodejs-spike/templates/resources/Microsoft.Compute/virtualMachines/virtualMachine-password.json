{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "source": {
      "type": "object"
    },
    "secret": {
      "type": "securestring"
    }
  },
  "variables": {},
  "resources": [
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2017-03-30",
      "name": "[parameters('source').name]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "VM"
      },
      "properties": {
        "availabilitySet": "[parameters('source').availabilitySet]",
        "hardwareProfile": "[parameters('source').hardwareProfile]",
        "osProfile": {
          "computerName": "[parameters('source').computerName]",
          "adminUsername": "[parameters('source').adminUsername]",
          "adminPassword": "[parameters('secret')]",
          "[concat(toLower(parameters('source').storageProfile.osDisk.osType), 'Configuration')]": "[parameters('source')[concat(toLower(parameters('source').storageProfile.osDisk.osType), 'Configuration')]]"
        },
        "storageProfile": "[parameters('source').storageProfile]",
        "networkProfile": "[parameters('source').networkProfile]",
        "diagnosticsProfile": "[parameters('source').diagnosticsProfile]",
        "licenseType": "[parameters('source').licenseType]"
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[parameters('source').extensions[0].name]",
      "apiVersion": "2015-06-15",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[parameters('source').name]"
      ],
      "properties": {
        "publisher": "[parameters('source').extensions[0].publisher]",
        "type": "[parameters('source').extensions[0].type]",
        "typeHandlerVersion": "[parameters('source').extensions[0].typeHandlerVersion]",
        "autoUpgradeMinorVersion": "[parameters('source').extensions[0].autoUpgradeMinorVersion]",
        "protectedSettings": "[parameters('source').extensions[0].protectedSettings]",
        "settings": "[parameters('source').extensions[0].settings]"
      }
    }
  ]
}